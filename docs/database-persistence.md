# 数据库持久化与初始化说明

## 概述

本项目使用 Cloudflare D1 数据库作为持久化存储，支持数据持久化功能。为了防止在重新部署时数据丢失，我们实现了智能初始化机制。

## 重要注意事项：数据库UUID变化问题

### 问题描述

当 D1 数据库被删除后重新创建时，虽然数据库名称相同，但 **UUID 会发生变化**。这会导致以下问题：

- Worker 无法找到正确的数据库绑定
- 部署脚本可能无法正确识别数据库状态
- 系统无法正常访问数据库

### 解决方案

部署脚本已优化，能够自动处理数据库UUID变化：

1. **动态获取数据库ID**：部署时自动查询当前数据库的UUID
2. **更新配置绑定**：自动更新 `wrangler.toml` 中的 `database_id` 字段
3. **智能状态检测**：正确判断数据库是否存在和是否已初始化

## 数据持久化机制

### 智能初始化
- 部署脚本会自动检测数据库是否已存在
- 如果数据库已存在，部署过程不会重复初始化数据库表结构
- 只有在首次部署时才会创建数据库并执行初始化脚本
- 这样确保了在重新部署或更新应用时，已有数据不会丢失

### 初始化脚本
项目包含两个初始化脚本，可以根据需要选择执行：
- `d1-init.sql`：完整的数据库初始化脚本，包含所有表结构和初始数据
- `d1-init-basic.sql`：基础数据库初始化脚本，仅包含核心表结构

## 部署流程

### 首次部署（本地脚本 `npm run deploy` 场景）
1. 使用本地部署脚本检测 `temp_mail_db` 是否存在，如不存在则创建新的 D1 数据库
2. 对目标数据库执行初始化脚本（默认使用 `d1-init.sql`，也可以手动改为 `d1-init-basic.sql`）
3. 更新 `wrangler.toml` 中的 D1 绑定配置
4. 部署 Worker 代码

### 后续部署（包括数据库被删除后重建）
1. 检测 `temp_mail_db` 是否存在
2. 如数据库不存在（已被删除），则重新创建 D1 数据库并执行初始化脚本
3. 如数据库存在且已初始化，跳过初始化步骤，仅更新绑定并部署 Worker 代码

### 数据库被删除后的处理
如果 D1 数据库被意外删除，本地部署脚本可以：
- 检测到数据库不存在
- 自动重新创建数据库
- 执行初始化脚本
- 继续部署 Worker 代码

## 手动管理

### 检查数据库状态
```bash
# 检查本地数据库
npm run d1:query:local -- --command "SELECT name FROM sqlite_master WHERE type='table';"

# 检查远程数据库
npm run d1:query:remote -- --command "SELECT name FROM sqlite_master WHERE type='table';"
```

### 手动初始化（谨慎使用）
```bash
# 本地初始化
npm run d1:execute-basic:local

# 远程初始化（会清空现有数据）
npm run d1:execute-basic:remote
```

## 故障排除

### 数据库未正确初始化
如果发现数据库表结构不完整：
1. 检查部署日志中是否有数据库初始化错误
2. 手动执行初始化脚本
3. 确认环境变量配置正确

### 重复初始化问题
如果遇到重复初始化问题：
1. 检查部署脚本中的数据库存在检测逻辑
2. 确认数据库连接配置正确
3. 检查是否有权限问题

## 最佳实践

1. **备份重要数据**：虽然有持久化机制，但仍然建议定期备份重要数据
2. **谨慎手动初始化**：手动初始化会清空现有数据，请谨慎操作
3. **监控部署日志**：关注部署过程中的数据库相关日志
4. **环境隔离**：开发、测试、生产环境应使用不同的数据库实例
